{% extends 'base.html' %}

{% block content %}
    <h2>添加计算机</h2>
    <form class="form" method="post">
        {% csrf_token %}
        <div class="form-group">
            <label for="name">名称</label>
            {{ form.name }}
        </div>
        <div class="form-group">
            <label for="cpu_id">CPU_ID</label>
            <input type="text" class="form-control" id="cpu_id" readonly>
            {{ form.cpu_id }}
        </div>
        {% for error in form.non_field_errors %}
            <div class="alert alert-danger">{{ error }}</div>
        {% endfor %}
        <input type="submit" class="btn btn-primary" value="提交" disabled>
    </form>
    {% load staticfiles %}
    <h3>获取 CPU_ID 设置</h3>
    <p>获取 CPU_ID 只能在IE浏览器中实现，请在IE浏览器中进行如下设置。当签到设置中指定了计算机，则签到只能在该电脑的IE浏览器中打开二维码签到界面来完成</p>
    <h4>步骤一</h4>
    <img class="img-responsive" src="{% static 'img/step1.png' %}" alt="步骤一">
    <h4>步骤二</h4>
    <img class="img-responsive" src="{% static 'img/step2.png' %}" alt="步骤二">
    <h4>步骤三</h4>
    <img class="img-responsive" src="{% static 'img/step3.png' %}" alt="步骤三">
    <h4>步骤四</h4>
    <img class="img-responsive" src="{% static 'img/step4.png' %}" alt="步骤四">
{% endblock %}

{% block extrascript %}
    <script>
        window.onload = function () {
            var id = getCpuId();
            if (id) {
                $("input#cpu_id").val(id);
                $("input#id_cpu_id").val(id);
                $("input[type='submit']").removeAttr("disabled");
            } else {
                alert("无法获取CPU信息，请使用IE，并作相应设置");
            }
        };

        function getCpuId() {
            try {
                var locator = new ActiveXObject("WbemScripting.SWbemLocator");
                var service = locator.ConnectServer(".");
                var cpu = new Enumerator(service.ExecQuery("SELECT * FROM Win32_Processor")).item();
            } catch (e) {
                return null
            }
            return cpu.ProcessorID;
        }
    </script>
{% endblock %}

